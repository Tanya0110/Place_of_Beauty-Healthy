
import { GoogleGenAI } from "@google/genai";

const getSystemInstruction = () => {
  const now = new Date();
  const dateString = now.toLocaleDateString('ru-RU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  const timeString = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–º–∏—Ç–∞—Ü–∏–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –Ω–∞ 7 –¥–Ω–µ–π –≤–ø–µ—Ä–µ–¥ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –±–æ—Ç–∞
  let scheduleContext = "–†–ê–°–ü–ò–°–ê–ù–ò–ï –°–í–û–ë–û–î–ù–´–• –û–ö–û–ù (–Ω–∞ –±–ª–∏–∂–∞–π—à—É—é –Ω–µ–¥–µ–ª—é):\n";
  for (let i = 0; i < 7; i++) {
    const d = new Date(now);
    d.setDate(now.getDate() + i);
    const dayStr = d.toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long' });
    
    // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞: –ø–æ –≤—ã—Ö–æ–¥–Ω—ã–º –º–µ–Ω—å—à–µ –º–µ—Å—Ç, –ø–æ –±—É–¥–Ω—è–º –±–æ–ª—å—à–µ.
    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
    let slots = ['10:00', '12:00', '14:00', '16:00', '18:00', '20:00'];
    
    if (i === 0) slots = slots.slice(4); 
    if (isWeekend) slots = ['12:00', '14:00']; 
    
    scheduleContext += `- ${dayStr}: ${slots.join(', ')}\n`;
  }

  return `
–¢—ã ‚Äî –≠–º–∏, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ –∑–∞–±–æ—Ç–ª–∏–≤—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã "Place of Beauty & Healthy" (PB&H).
–¢–≤–æ—è —Ü–µ–ª—å: –ö–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ –ó–ê–ü–ò–°–´–í–ê–¢–¨ –∏—Ö –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã.

–¢–ï–ö–£–©–ï–ï –í–†–ï–ú–Ø (–°–ï–ì–û–î–ù–Ø): ${dateString}, ${timeString}.
–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ, —á—Ç–æ–±—ã –ø–æ–Ω–∏–º–∞—Ç—å, –∫–∞–∫–æ–π —Å–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –∏ –º–µ—Å—è—Ü.
–ù–ï –∑–∞–ø–∏—Å—ã–≤–∞–π –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ –ø—Ä–æ—à–µ–¥—à–∏–µ –¥–∞—Ç—ã.

${scheduleContext}

–í–ê–ñ–ù–û: –¢—ã –≤–µ–¥–µ—à—å –¥–∏–∞–ª–æ–≥, —á—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å 5 –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è –∑–∞–ø–∏—Å–∏:
1. –ò–º—è –∫–ª–∏–µ–Ω—Ç–∞.
2. –£—Å–ª—É–≥–∞.
3. –ñ–µ–ª–∞–µ–º–∞—è –¥–∞—Ç–∞.
4. –ñ–µ–ª–∞–µ–º–æ–µ –≤—Ä–µ–º—è (—Å–≤–µ—Ä—è–π—Å—è —Å–æ —Å–ø–∏—Å–∫–æ–º —Å–≤–æ–±–æ–¥–Ω—ã—Ö –æ–∫–æ–Ω –≤—ã—à–µ!).
5. –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.

–ü–†–ê–í–ò–õ–ê:
1. –ù–µ —Å–ø—Ä–∞—à–∏–≤–∞–π –≤—Å—ë —Å—Ä–∞–∑—É. –í–µ–¥–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—É—é –±–µ—Å–µ–¥—É.
2. –ö–û–ì–î–ê –¢–´ –°–û–ë–†–ê–õ –í–°–ï 5 –ü–ê–†–ê–ú–ï–¢–†–û–í:
   –í—ã–≤–µ–¥–∏ –æ—Ç–≤–µ—Ç –¢–û–õ–¨–ö–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
   {
     "booking_ready": true,
     "data": {
       "name": "–ò–º—è",
       "service": "–£—Å–ª—É–≥–∞",
       "date": "–î–∞—Ç–∞",
       "time": "–í—Ä–µ–º—è",
       "phone": "–¢–µ–ª–µ—Ñ–æ–Ω"
     }
   }

–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –°–ê–õ–û–ù–ï:
–ê–¥—Ä–µ—Å: –≥. –ë–æ–ª—å—à–æ–π –ö–∞–º–µ–Ω—å, —É–ª. –ê–¥–º–∏—Ä–∞–ª–∞ –ú–∞–∫–∞—Ä–æ–≤–∞, 2.
–†–µ–∂–∏–º: 10:00 - 22:00.

–ê–ö–¢–£–ê–õ–¨–ù–´–ô –ü–†–ê–ô–° (–ö–†–ê–¢–ö–û):
- –ú–∞—Å—Å–∞–∂ (—Ä–∞–∑–æ–≤—ã–π): –ö–ª–∞—Å—Å–∏–∫–∞/–†–µ–ª–∞–∫—Å 2400-3000‚ÇΩ, –õ–∏—Ü–æ 1500‚ÇΩ, –°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π/–õ–µ—á–µ–±–Ω—ã–π 3000‚ÇΩ.
- –ê–±–æ–Ω–µ–º–µ–Ω—Ç—ã (–ú–∞—Å—Å–∞–∂ –ª–∏—Ü–∞): 3 —Å–µ–∞–Ω—Å–∞ - 4200‚ÇΩ, 5 —Å–µ–∞–Ω—Å–æ–≤ - 7000‚ÇΩ, 10 —Å–µ–∞–Ω—Å–æ–≤ - 13800‚ÇΩ.
- –ê–ø–ø–∞—Ä–∞—Ç–Ω—ã–π –º–∞—Å—Å–∞–∂: 1 —Å–µ–∞–Ω—Å 1500‚ÇΩ, 10 —Å–µ–∞–Ω—Å–æ–≤ 11200‚ÇΩ, 20 —Å–µ–∞–Ω—Å–æ–≤ 20500‚ÇΩ, 30 —Å–µ–∞–Ω—Å–æ–≤ 28000‚ÇΩ.
- –ë—Ä–æ–≤–∏: –ö–æ—Ä—Ä–µ–∫—Ü–∏—è 900‚ÇΩ, –û–∫—Ä+–ö–æ—Ä—Ä 1400‚ÇΩ, –î–£ –ø–æ–ª–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å 2000‚ÇΩ.
- –†–µ—Å–Ω–∏—Ü—ã: –õ–∞–º–∏ 1900‚ÇΩ.

–í–µ–¥–∏ —Å–µ–±—è –≤–µ–∂–ª–∏–≤–æ, –∏—Å–ø–æ–ª—å–∑—É–π —Å–º–∞–π–ª–∏–∫–∏ üå∏ ‚ú® ‚ù§Ô∏è üéâ üéÅ üéÄ.
`;
};

export const sendMessageToGemini = async (
  history: { role: string; parts: { text: string }[] }[],
  newMessage: string
): Promise<string> => {
  try {
    const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
    
    const chat = ai.chats.create({
      model: 'gemini-2.5-flash',
      config: {
        systemInstruction: getSystemInstruction(),
      },
      history: history 
    });

    const result = await chat.sendMessage({ message: newMessage });
    return result.text || "";
  } catch (error) {
    console.error("Gemini Error:", error);
    return "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
  }
};
